<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Eid Greeting Cards | بطاقات العيد</title>
    <link rel="icon" type="image/x-icon" href="assets/images/favicon.ico" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />
    <link rel="stylesheet" href="assets/css/landing.css" />
    <link rel="stylesheet" href="assets/css/card-flow.css" />
  </head>
  <body>
    <!-- Landing: language + hero + company grid -->
    <section class="landing-showcase" id="landingShowcase">
      <header class="landing-header">
        <div class="container">
          <div class="d-flex justify-content-center align-items-center flex-wrap gap-2">
            <span class="me-2" id="langLabel">Language / اللغة</span>
            <button type="button" class="lang-btn" data-lang="ar" id="btnLangAr">العربية</button>
            <button type="button" class="lang-btn" data-lang="en" id="btnLangEn">English</button>
          </div>
        </div>
      </header>

      <div class="landing-hero">
        <h1 class="landing-hero-title" id="landingHeroTitle">A Ramadan Greeting for Someone Special</h1>
        <p class="landing-hero-subtitle" id="landingHeroSubtitle">Select your preferred design and create a personalized card to share with those who matter most.</p>
      </div>

      <section class="company-cards-section" aria-labelledby="companyCardsSectionTitle">
        <div class="company-cards-block" id="companyCardsBlock" hidden>
          <div class="company-cards-deck" id="companyCardsDeck" role="list">
            <div class="company-cards-deck-container" id="companyCardsDeckContainer"></div>
          </div>
          <h2 class="company-cards-block-title" id="companyCardsSectionTitle">Swipe and choose</h2>
        </div>
        <p class="landing-empty" id="landingEmpty" hidden>No cards available at the moment.</p>
      </section>

      <footer class="landing-footer" dir="ltr">
        <p class="mb-0 d-flex justify-content-center align-items-center flex-wrap gap-1">
          <span>Powered by</span>
          <a href="https://6degrees.com.sa/en" target="_blank" rel="noopener noreferrer" class="text-decoration-none d-inline-block">
            <img src="assets/images/6degrees-logo.png" alt="6 Degrees" style="height: 28px;" />
          </a>
        </p>
      </footer>
    </section>

    <!-- Three steps: shown after choosing a card -->
    <section class="landing-steps" id="landingSteps" hidden>
      <div class="card-flow-container">
        <div id="cardFlowLive" class="sr-only" aria-live="polite" aria-atomic="true"></div>
        <div class="step-indicator" id="stepIndicator" role="tablist">
          <button type="button" class="step-tab" data-step="1" role="tab" aria-selected="true">
            <span class="step-dot" data-step="1"></span>
            <span class="step-tab-label" id="stepTabLabel1">Message</span>
          </button>
          <button type="button" class="step-tab" data-step="2" role="tab" aria-selected="false">
            <span class="step-dot" data-step="2"></span>
            <span class="step-tab-label" id="stepTabLabel2">Name</span>
          </button>
          <button type="button" class="step-tab" data-step="3" role="tab" aria-selected="false">
            <span class="step-dot" data-step="3"></span>
            <span class="step-tab-label" id="stepTabLabel3">Preview</span>
          </button>
        </div>

        <div class="card-preview-wrap">
          <canvas id="previewCanvas" width="1080" height="1920"></canvas>
          <div class="card-preview-error" id="previewImageError" hidden>
            <p class="card-preview-error-text" id="previewImageErrorText"></p>
            <button type="button" class="btn btn-outline-light btn-sm mt-2" id="previewImageErrorBack"></button>
          </div>
        </div>

        <div class="step-panel active" id="panelStep1" data-step="1">
          <h2 id="step1Title">Choose your message</h2>
          <div class="message-options" id="messageOptions"></div>
          <div class="card-flow-actions">
            <button type="button" class="btn btn-outline-light" id="backToCardsFromStep1">Back</button>
            <button type="button" class="btn btn-light" id="nextFrom1">Next</button>
          </div>
        </div>

        <div class="step-panel" id="panelStep2" data-step="2">
          <h2 id="step2Title">Enter your name</h2>
          <div class="name-input-wrap">
            <input type="text" class="form-control" id="nameInput" placeholder="Enter your name" autocomplete="name" />
          </div>
          <div class="card-flow-actions">
            <button type="button" class="btn btn-outline-light" id="backTo1">Back</button>
            <button type="button" class="btn btn-light" id="nextFrom2">Next</button>
          </div>
        </div>

        <div class="step-panel" id="panelStep3" data-step="3">
          <h2 id="step3Title">Preview & Download</h2>
          <p class="card-flow-hint" id="nameReminder" hidden></p>
          <button type="button" class="btn btn-link card-flow-hint-link" id="nameReminderGoToStep2" hidden>Edit name</button>
          <p class="card-flow-success" id="downloadSuccessMsg" hidden></p>
          <div class="card-flow-actions">
            <button type="button" class="btn btn-outline-light" id="backTo2">Back</button>
            <button type="button" class="btn btn-light" id="downloadCard">Download card</button>
          </div>
        </div>
      </div>

      <footer class="card-flow-footer" dir="ltr">
        <p class="mb-0 d-flex justify-content-center align-items-center flex-wrap gap-1">
          <span>Powered by</span>
          <a href="https://6degrees.com.sa/en" target="_blank" rel="noopener noreferrer" class="text-decoration-none d-inline-block">
            <img src="assets/images/6degrees-logo.png" alt="6 Degrees" style="height: 28px;" />
          </a>
        </p>
      </footer>
    </section>

    <script src="assets/js/companies-config.js"></script>
    <script src="assets/js/card-flow.js"></script>
    <script>
      (function() {
        var DEFAULT_LANG = 'en';
        var lang = sessionStorage.getItem('card-lang') || DEFAULT_LANG;
        var companies = window.COMPANIES_CONFIG || [];

        var titles = {
          en: {
            heroTitle: 'A Ramadan Greeting for Someone Special',
            heroSubtitle: 'Select your preferred design and create a personalized card to share with those who matter most.',
            sectionTitle: 'Swipe and choose',
            emptyGrid: 'No cards available at the moment.'
          },
          ar: {
            heroTitle: 'تهنئة رمضانية لمن يعزّ عليك',
            heroSubtitle: 'اختر تصميم بطاقتك وأنشئ تهنئة مميزة تشاركها مع من تحب.',
            sectionTitle: 'اسحب واختر',
            emptyGrid: 'لا توجد بطاقات متاحة حاليًا.'
          }
        };

        function setLang(newLang) {
          lang = newLang;
          sessionStorage.setItem('card-lang', lang);
          document.documentElement.lang = lang === 'ar' ? 'ar' : 'en';
          document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
          document.getElementById('landingHeroTitle').textContent = titles[lang].heroTitle;
          document.getElementById('landingHeroSubtitle').textContent = titles[lang].heroSubtitle;
          var sectionTitleEl = document.getElementById('companyCardsSectionTitle');
          if (sectionTitleEl) sectionTitleEl.textContent = titles[lang].sectionTitle;
          document.querySelectorAll('.lang-btn').forEach(function(btn) {
            btn.classList.toggle('active', btn.getAttribute('data-lang') === lang);
          });
          var deckContainer = document.getElementById('companyCardsDeckContainer');
          if (deckContainer) {
            deckContainer.querySelectorAll('.company-card-deck-item').forEach(function(card, i) {
              var c = companies[i];
              if (!c) return;
              var img = card.querySelector('img');
              if (img) img.alt = lang === 'ar' ? c.nameAr : c.nameEn;
              var selectText = lang === 'ar' ? 'اختر هذه البطاقة' : 'Select this card';
              card.setAttribute('aria-label', (lang === 'ar' ? c.nameAr : c.nameEn) + ' - ' + selectText);
            });
          }
          var emptyEl = document.getElementById('landingEmpty');
          if (emptyEl) emptyEl.textContent = titles[lang].emptyGrid;
        }

        document.getElementById('btnLangAr').addEventListener('click', function() { setLang('ar'); });
        document.getElementById('btnLangEn').addEventListener('click', function() { setLang('en'); });

        var showcase = document.getElementById('landingShowcase');
        var stepsSection = document.getElementById('landingSteps');

        function showSteps() {
          showcase.setAttribute('hidden', '');
          stepsSection.removeAttribute('hidden');
        }

        function showLanding() {
          stepsSection.setAttribute('hidden', '');
          showcase.removeAttribute('hidden');
        }
        window.goBackToCards = showLanding;

        var backFromStep1 = document.getElementById('backToCardsFromStep1');
        if (backFromStep1) backFromStep1.addEventListener('click', function(e) {
          e.preventDefault();
          showLanding();
        });

        var block = document.getElementById('companyCardsBlock');
        var deckContainer = document.getElementById('companyCardsDeckContainer');
        var emptyEl = document.getElementById('landingEmpty');
        var currentDeckIndex = 0;
        var isDragging = false;
        var startX = 0;
        var currentX = 0;
        var threshold = 50;

        function updateDeckPosition(index) {
          if (!deckContainer || companies.length === 0) return;
          // Loop the index: wrap around using modulo
          currentDeckIndex = ((index % companies.length) + companies.length) % companies.length;
          var cards = deckContainer.querySelectorAll('.company-card-deck-item');
          cards.forEach(function(card, i) {
            var diff = i - currentDeckIndex;
            // Handle wrapping: calculate shortest distance considering loop
            var forwardDist = diff >= 0 ? diff : diff + companies.length;
            var backwardDist = diff <= 0 ? -diff : companies.length - diff;
            var absDiff = Math.min(forwardDist, backwardDist);
            // Determine actual diff for rotation/translation (considering wrap)
            if (Math.abs(diff) <= companies.length / 2) {
              // Normal case: no wrap needed
            } else if (diff > 0) {
              diff = diff - companies.length;
            } else {
              diff = diff + companies.length;
            }
            
            var zIndex = companies.length - absDiff;
            var rotate = diff * 8;
            var translateX = diff * 38;
            var translateY = absDiff * 14;
            var scale = absDiff === 0 ? 1 : Math.max(0.85, 1 - absDiff * 0.05);
            var opacity = absDiff <= 2 ? 1 : Math.max(0, 1 - (absDiff - 2) * 0.3);
            
            card.style.zIndex = zIndex;
            card.style.transform = 'translate(' + translateX + 'px, ' + translateY + 'px) rotate(' + rotate + 'deg) scale(' + scale + ')';
            card.style.opacity = opacity;
            var isActive = absDiff === 0;
            card.classList.toggle('active', isActive);
            card.style.pointerEvents = isActive ? 'auto' : 'none';
            card.setAttribute('tabindex', isActive ? '0' : '-1');
            if (isActive) {
              card.setAttribute('aria-current', 'true');
            } else {
              card.removeAttribute('aria-current');
            }
          });
        }

        function handleDeckSwipe(deltaX) {
          if (Math.abs(deltaX) > threshold) {
            if (deltaX > 0) {
              // Swipe right = go to previous (wrap around)
              updateDeckPosition(currentDeckIndex - 1);
            } else if (deltaX < 0) {
              // Swipe left = go to next (wrap around)
              updateDeckPosition(currentDeckIndex + 1);
            }
          }
        }

        function initDeckSwipe() {
          if (!deckContainer) return;
          var touchStartX = 0;
          var touchStartY = 0;
          var mouseStartX = 0;

          deckContainer.addEventListener('touchstart', function(e) {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            isDragging = false;
          });

          deckContainer.addEventListener('touchmove', function(e) {
            var deltaX = e.touches[0].clientX - touchStartX;
            var deltaY = e.touches[0].clientY - touchStartY;
            if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 10) {
              isDragging = true;
              e.preventDefault();
              var offset = Math.max(-100, Math.min(100, deltaX * 0.5));
              deckContainer.style.transform = 'translateX(' + offset + 'px)';
            }
          });

          deckContainer.addEventListener('touchend', function(e) {
            if (!isDragging) return;
            isDragging = false;
            var deltaX = e.changedTouches[0].clientX - touchStartX;
            deckContainer.style.transform = '';
            handleDeckSwipe(deltaX);
          });

          deckContainer.addEventListener('mousedown', function(e) {
            mouseStartX = e.clientX;
            isDragging = false;
          });

          deckContainer.addEventListener('mousemove', function(e) {
            var deltaX = e.clientX - mouseStartX;
            if (Math.abs(deltaX) > 10) {
              isDragging = true;
              var offset = Math.max(-100, Math.min(100, deltaX * 0.5));
              deckContainer.style.transform = 'translateX(' + offset + 'px)';
            }
          });

          deckContainer.addEventListener('mouseup', function(e) {
            if (!isDragging) return;
            isDragging = false;
            var deltaX = e.clientX - mouseStartX;
            deckContainer.style.transform = '';
            handleDeckSwipe(deltaX);
          });

          deckContainer.addEventListener('mouseleave', function() {
            if (isDragging) {
              isDragging = false;
              deckContainer.style.transform = '';
            }
          });

          // Keyboard navigation (looping)
          document.addEventListener('keydown', function(e) {
            if (document.getElementById('landingShowcase') && !document.getElementById('landingShowcase').hasAttribute('hidden')) {
              if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                var activeCard = deckContainer.querySelector('.company-card-deck-item.active');
                if (activeCard) {
                  e.preventDefault();
                  if (e.key === 'ArrowLeft') {
                    updateDeckPosition(currentDeckIndex - 1);
                  } else if (e.key === 'ArrowRight') {
                    updateDeckPosition(currentDeckIndex + 1);
                  }
                }
              }
            }
          });
        }

        if (companies.length === 0) {
          if (block) block.setAttribute('hidden', '');
          if (emptyEl) {
            emptyEl.removeAttribute('hidden');
            emptyEl.textContent = titles[lang].emptyGrid;
          }
        } else {
          if (emptyEl) emptyEl.setAttribute('hidden', '');
          if (block) block.removeAttribute('hidden');
          if (deckContainer) {
            deckContainer.innerHTML = '';
            companies.forEach(function(c, i) {
              var card = document.createElement('button');
              card.type = 'button';
              card.className = 'company-card-deck-item';
              card.setAttribute('data-company-id', c.id);
              card.setAttribute('data-index', i);
              card.setAttribute('role', 'listitem');
              card.setAttribute('aria-label', (lang === 'ar' ? c.nameAr : c.nameEn) + ' - ' + (lang === 'ar' ? 'اختر هذه البطاقة' : 'Select this card'));
              card.setAttribute('tabindex', '-1');
              var img = document.createElement('img');
              img.src = c.image;
              img.alt = lang === 'ar' ? c.nameAr : c.nameEn;
              img.className = 'company-card-deck-img';
              img.loading = 'lazy';
              img.onerror = function() {
                this.style.opacity = '0.5';
                this.alt = (lang === 'ar' ? 'فشل تحميل الصورة' : 'Failed to load image');
              };
              card.appendChild(img);
              var cardClickHandler = function(e) {
                if (this.classList.contains('active') && !isDragging) {
                  e.preventDefault();
                  e.stopPropagation();
                  var id = this.getAttribute('data-company-id');
                  sessionStorage.setItem('card-company', id);
                  showSteps();
                  if (window.startCardFlow) window.startCardFlow(id);
                }
              };
              card.addEventListener('click', cardClickHandler);
              card.addEventListener('keydown', function(e) {
                if ((e.key === 'Enter' || e.key === ' ') && this.classList.contains('active')) {
                  e.preventDefault();
                  cardClickHandler.call(this, e);
                }
              });
              deckContainer.appendChild(card);
            });
            var startIndex = Math.floor(companies.length / 2);
            updateDeckPosition(startIndex);
            initDeckSwipe();
            // Indicators always visible since we loop infinitely
          }
        }

        setLang(lang);
      })();
    </script>
  </body>
</html>
